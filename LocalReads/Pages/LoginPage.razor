@page "/login"

@inject IAuthService AuthService
@inject NavigationManager Navigation
@layout LoginLayout

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge"  
    Class="d-flex flex-column align-center justify-center" 
    Style="min-height: 100vh; min-width: 99vw; background-image: url('https://images.unsplash.com/photo-1526243741027-444d633d7365?q=80&w=2071&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');">
    <MudPaper Elevation="6" Class="pa-6" Style="width:100%; max-width:400px;">
        <MudStack Spacing="2" AlignItems="AlignItems.Center">
            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" Color="Color.Primary" />
            <MudText Typo="Typo.h4" Class="mb-1">Sign in to LocalReads</MudText>
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-4">Welcome back! Please enter your credentials.</MudText>
        </MudStack>
        <MudForm @ref="_form" Model="@Login" Class="mb-4">
            <MudTextField T="string" Label="Username" @bind-Value="@Login.UserName" Required="true" For="@(() => Login.UserName)" />
            <MudTextField T="string" Label="Password" @bind-Value="@Login.Password" InputType="InputType.Password" Required="true" For="@(() => Login.Password)" />
            @if (!string.IsNullOrEmpty(_error))
            {
                <MudText Typo="Typo.caption" Color="Color.Error" Class="mt-2">@_error</MudText>
            }
        </MudForm>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="my-2" FullWidth="true" Disabled="@_isLoading" OnClick="HandleLogin">
            @if (_isLoading)
            {
                <MudProgressCircular Indeterminate="true" Size="Size.Medium" Class="me-2" />
                <MudText Typo="Typo.body1" Color="Color.Secondary">Signing in...</MudText>        
            }
            else
            {
                <MudText Typo="Typo.body1" Style="color: white">Login</MudText>
            }
        </MudButton>
        <MudText Typo="Typo.body2" Align="Align.Center" Class="mt-3">
            Don't have an account?
            <MudLink Href="/register" Color="Color.Primary" Class="ms-1">Register</MudLink>
        </MudText>
    </MudPaper>
</MudContainer>

@code {

    private Login Login { get; } = new Login();
    private MudForm _form;

    private string _error = string.Empty;
    private bool _isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        if (await AuthService.IsLoggedIn())
            Navigation.NavigateTo("/");
    }

    public async Task HandleLogin()
    {
        _error =  string.Empty;
        await _form.Validate();
        if (!_form.IsValid)
            return;

        _isLoading = true;
        var isSigned = await AuthService.Login(Login);
        _isLoading = false;

        if (isSigned)
            Navigation.NavigateTo("/");
        else
            _error = "Invalid username or password.";
    }
}