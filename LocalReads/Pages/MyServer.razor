@page "/myserver"
@inject IHttpRequest HttpRequest
@inject NavigationManager Navigation

<MudGrid Class="px-4" Style="min-height: 600px;">
    <MudItem xs="12" md="5" lg="4" Style="color: white">
        <MudPaper Class="pa-0" Style="height:100%; min-height:500px; background: white;">
            <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.ArrowBack" Class="ml-6 mt-4">Back</MudButton>
            <MudText Typo="Typo.body1" Class="mb-4 pt-6 px-6">Server Members</MudText>
            <div class="user-list-scroll px-4 pb-4">
                <MudList T="UserResponse" Dense="false">
                    @if (Users.Count == 0)
                    {
                        <MudText Typo="Typo.body1" Color="Color.Secondary">No users found.</MudText>
                    }
                    else
                    {
                        @foreach (var user in Users)
                        {
                            <MudListItem Style="cursor:pointer; border-bottom: 2px solid #eee" @onclick="() => GoToUser(user.Id)">
                                <MudElement Class="d-flex flex-row ma-0 pa-0">
                                    <MudAvatar Size="Size.Medium" Color="Color.Tertiary" Style="background-color: #70b9ff; padding: 15px; margin-right: 2rem">
                                        @user.Name?.FirstOrDefault()</MudAvatar>
                                    <MudElement>
                                        <MudText Typo="Typo.subtitle1" Class="fw-bold" Style="color: var(--mud-palette-primary-dark);">@user.Name</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">@user.UserName</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">@user.Location</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Info">@user.FavoriteBooksCount books</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Primary" Class="mt-1">
                                            Currently reading: <b>@user.CurrentlyReading</b>
                                        </MudText>
                                    </MudElement>
                                </MudElement>

                            </MudListItem>
                        }
                    }
                </MudList>
            </div>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="7" lg="8">
        <MudPaper Class="pa-6 d-flex flex-column align-items-center justify-center" Style="height:100%; min-height:500px;">
                <MudElement Class="d-flex flex-column" Style="height: 100%">
                    <MudText Typo="Typo.body1" Class="mb-4">Most Read Book</MudText>
                    <div class="server-books pa-3 d-flex justify-start align-center">
                        @foreach (var fav in PopularBooks.MostReadBooks)
                        {
                            <MudElement Class="d-flex flex-column mb-2 pa-4" Style="max-width: 300px;">
                                <MudImage Src="@fav.Book.ImageLink" Width="90" Height="130" Class="mr-2" />
                                <MudElement Class="d-flex flex-column">
                                    <MudButton
                                        Variant="Variant.Outlined"
                                        Size="Size.Small"
                                        Color="Color.Secondary"
                                        FullWidth="false"
                                        @onclick="@(e => Navigation.NavigateTo($"/viewbook/{@fav.Book.BookGoogleId}"))"
                                        Style="width: 100px; margin-top: 10px">Go to book</MudButton>
                                </MudElement>
                            </MudElement>
                        }
                    </div>
                </MudElement>
        </MudPaper>
    </MudItem>
</MudGrid>

<style>
    .server-books {
        scrollbar-width: thin;
        overflow: auto;
    }
    .user-list-scroll {
        max-height: 520px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--mud-palette-primary) var(--mud-palette-background-grey);
    }
    .user-list-scroll::-webkit-scrollbar {
        width: 8px;
        background: var(--mud-palette-background-grey);
    }
    .user-list-scroll::-webkit-scrollbar-thumb {
        background: var(--mud-palette-primary-light);
        border-radius: 4px;
    }
</style>

@code {
    private List<UserResponse> Users = new List<UserResponse>();
    private PopularBooks PopularBooks = new PopularBooks();

    protected override async Task OnInitializedAsync()
    {
        Users = (await HttpRequest.Get<List<UserResponse>>($"/users")).Content;
        PopularBooks = (await HttpRequest.Get<PopularBooks>($"/favorites/server")).Content;
    }

    private void GoToUser(int id)
    {
        Navigation.NavigateTo($"/profile/{id}");
    }
}
