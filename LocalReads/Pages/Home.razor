@page "/"
@using LocalReads.DTO
@using LocalReads.Services
@using LocalReads.Components
@using LocalReads.State
@using MudBlazor
@inject IOpenLibraryService OpenLibraryService
@inject AppState AppState
@inject IAuthService AuthService

<MudText>Resultados de: @AppState.SearchResults.TermSearch</MudText>
<MudDivider Style="margin-bottom: 2rem"/>

<MudGrid>
    @foreach(BookDto book in AppState.SearchResults.Books)
    {
        <BookCard Book="@book" />
    }
</MudGrid>

@code
{
    protected override async Task OnInitializedAsync()
    {
        AppState.SearchResults.OnChange += StateHasChanged;

        if (string.IsNullOrEmpty(AppState.SearchResults.TermSearch))
        {
            var books = (await OpenLibraryService.GetRandomBooks())
                .Select(BookDto.FromBook);
            AppState.SearchResults.SetSearchResults(books.ToList());
        }

        if (AppState.UserState.User == null)
        {
            await AuthService.PersistLoggedInUser();
        }

    }
    
    public void Dispose()
    {
        AppState.SearchResults.OnChange -= StateHasChanged;
    }
}
